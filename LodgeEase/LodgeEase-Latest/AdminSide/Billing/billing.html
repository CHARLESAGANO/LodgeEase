<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Requests - Lodge Ease</title>
    <!-- Remove this line if you're not using Google API -->
    <!-- <script src="https://apis.google.com/js/api.js"></script> -->
    <script type="module" src="../firebase.js"></script>
    <script type="module" src="../AInalysis/auth-check.js"></script>
    <script type="module" src="billing.js"></script>
    <script type="module" src="../Dashboard/transitions.js"></script>
    <link rel="stylesheet" href="../Dashboard/transitionStyle.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&family=Roboto:wght@400&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Add PageLogger initialization -->
    <script type="module">
        import { initializeFirebase } from '../firebase.js';
        import { PageLogger } from '../js/pageLogger.js';
        
        window.addEventListener('load', async () => {
            try {
                await initializeFirebase();
                console.log('Firebase initialized successfully');
                // PageLogger will handle navigation logging through auth state change
            } catch (error) {
                console.error('Error initializing Firebase:', error);
            }
        });
    </script>
</head>
<body>
    <div id="app">
        <!-- Common sidebar template for all admin pages -->
        <aside class="sidebar">
            <div class="logo-container">
                <img src="../images/LodgeEaseLogo.png" alt="Lodge Ease Logo" class="logo">
                <h2>Lodge Ease</h2>
            </div>
            <ul>
                <li><a href="../Dashboard/Dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="../Room Management/room_management.html"><i class="fas fa-bed"></i> Room Management</a></li>
                <li><a href="../Requests/booking_requests.html"><i class="fas fa-clock"></i> Booking Requests</a></li>
                <li><a href="../Billing/billing.html" class="active"><i class="fas fa-money-bill-wave"></i> Billing</a></li>
                <li><a href="../Reports/reports.html"><i class="fas fa-chart-line"></i> Reports</a></li>
                <li><a href="../BusinessAnalytics/business_analytics.html"><i class="fas fa-chart-pie"></i> Business Analytics</a></li>
                <li><a href="../ActivityLog/activity_log.html"><i class="fas fa-history"></i> Activity Log</a></li>
                <li><a href="../Settings/settings.html"><i class="fas fa-cog"></i> Settings</a></li>
                <li><a href="../LongTerm/longterm_management.html"><i class="fas fa-home"></i> Long-term Stays</a></li>
                <li><a href="../AInalysis/AInalysis.html"><i class="fas fa-robot"></i> ChatBot</a></li>
            </ul>
            <!-- Add auth buttons -->
            <div class="auth-buttons">
                <button v-if="isAuthenticated" @click="handleLogout" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> 
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header>
                <h1 class="text-3xl font-bold text-gray-800"></h1>
            </header>

            <!-- Add this right after <main class="main-content"> -->
            <div v-if="loading" class="loading">
                <i class="fas fa-spinner fa-spin"></i>
            </div>

            <section class="bill-list-section">
                <div class="bg-white p-6 rounded-lg shadow mx-auto max-w-6xl">
                    <div class="bill-list-header mb-4 flex justify-between items-center">
                        <div class="flex gap-4 items-center">
                            <button @click="openModal()" class="button">
                                <i class="fas fa-plus px-1"></i>Create Bill
                            </button>
                            <div class="flex items-center gap-2">
                                <input 
                                    type="date" 
                                    v-model="sortDate" 
                                    class="form-input rounded border p-2"
                                >
                                <button @click="filterByDate" class="button">
                                    <i class="fas fa-filter px-1"></i>Filter
                                </button>
                                <button @click="resetFilter" class="button bg-gray-500 hover:bg-gray-600">
                                    <i class="fas fa-sync-alt px-1"></i>Reset
                                </button>
                            </div>
                        </div>
                    </div>
                    <table id="billListTable" class="min-w-full divide-y divide-gray-200 bg-white rounded-lg overflow-hidden">
                        <thead>
                            <tr class="bg-gray-800 text-white">
                                <th class="px-6 py-4 text-left text-sm font-semibold uppercase tracking-wider rounded-tl-lg">Name</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold uppercase tracking-wider">Check-in</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold uppercase tracking-wider">Check-out</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold uppercase tracking-wider">Room Number</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold uppercase tracking-wider">Total Amount</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold uppercase tracking-wider rounded-tr-lg">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr v-if="showNoDataMessage" class="text-center">
                                <td colspan="6" class="px-6 py-8 text-gray-500 text-sm">No available data for selected date</td>
                            </tr>
                            <tr v-else v-for="bill in paginatedBills" :key="bill.id" class="hover:bg-gray-50 transition-colors duration-200">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ bill.customerName }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{{ formatDate(bill.date) }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{{ formatDate(bill.checkOut) }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{{ bill.roomNumber }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">â‚±{{ bill.totalAmount }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 actions">
                                    <button @click="viewBill(bill)" class="action-btn view-btn" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button @click="deleteBill(bill)" class="action-btn delete-btn" title="Delete Bill">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Update pagination section -->
                    <div class="bg-white px-4 py-3 border-t border-gray-200 sm:px-6 rounded-b-lg">
                        <div class="flex justify-between items-center">
                            <div class="text-sm text-gray-700">
                                Showing {{ ((currentPage - 1) * itemsPerPage) + 1 }} to {{ Math.min(currentPage * itemsPerPage, bills.length) }} of {{ bills.length }} bills
                            </div>
                            <div class="flex gap-2">
                                <button 
                                    @click="changePage(currentPage - 1)" 
                                    :disabled="currentPage === 1"
                                    class="button"
                                    :class="{ 'opacity-50 cursor-not-allowed': currentPage === 1 }"
                                >
                                    Previous
                                </button>
                                <button 
                                    @click="changePage(currentPage + 1)" 
                                    :disabled="currentPage === totalPages"
                                    class="button"
                                    :class="{ 'opacity-50 cursor-not-allowed': currentPage === totalPages }"
                                >
                                    Next
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Create Bill Modal -->
        <div id="createBillModal" class="modal" v-show="showModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Create New Bill</h2>
                    <span class="close" @click="closeModal">&times;</span>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="submitBill">
                        <div class="form-group">
                            <label for="customerName">Customer Name:</label>
                            <input type="text" id="customerName" v-model="newBill.customerName" required>
                        </div>
                        <div class="form-group">
                            <label for="billDate">Check-in:</label>
                            <input type="date" id="billDate" v-model="newBill.date" required>
                        </div>
                        <div class="form-group">
                            <label for="billCheckOut">Check-out:</label>
                            <input type="date" id="billCheckOut" v-model="newBill.checkOut" required>
                        </div>
                        <div class="form-group">
                            <label for="roomNumber">Room Number:</label>
                            <input type="number" id="roomNumber" v-model="newBill.roomNumber" required>
                        </div>
                        <div class="expenses-section">
                            <h3>Expenses</h3>
                            <div v-for="(expense, index) in newBill.expenses" :key="index" class="expense-item">
                                <input type="text" v-model="expense.description" placeholder="Description">
                                <input type="number" v-model="expense.amount" placeholder="Amount" step="0.01">
                                <button type="button" @click="removeExpense(index)" class="remove-expense">&times;</button>
                            </div>
                            <button type="button" @click="addExpense" class="button">Add Expense</button>
                        </div>
                        <div class="form-group total-amount">
                            <strong>Total Amount: â‚±{{ calculateTotal }}</strong>
                        </div>
                        <div class="modal-footer">
                            <button type="button" @click="closeModal" class="button cancel">Cancel</button>
                            <button type="submit" class="button">Create Bill</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- View/Edit Bill Modal -->
        <div id="viewBillModal" class="modal" v-show="showViewModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Bill</h2>
                    <span class="close" @click="closeViewModal">&times;</span>
                </div>
                <div class="modal-body" v-if="editingBill">
                    <form @submit.prevent="updateBill">
                        <div class="form-group">
                            <label for="editCustomerName">Customer Name:</label>
                            <input type="text" id="editCustomerName" v-model="editingBill.customerName" required>
                        </div>
                        <div class="form-group">
                            <label for="editBillDate">Check-in:</label>
                            <input type="date" id="editBillDate" v-model="editingBill.date" required>
                        </div>
                        <div class="form-group">
                            <label for="editBillCheckOut">Check-out:</label>
                            <input type="date" id="editBillCheckOut" v-model="editingBill.checkOut" required>
                        </div>
                        <div class="form-group">
                            <label for="editRoomNumber">Room Number:</label>
                            <input type="number" id="editRoomNumber" v-model="editingBill.roomNumber" required>
                        </div>
                        <div class="expenses-section">
                            <h3>Expenses</h3>
                            <div v-for="(expense, index) in editingBill.expenses" :key="index" class="expense-item">
                                <input type="text" v-model="expense.description" placeholder="Description">
                                <input type="number" v-model="expense.amount" placeholder="Amount" step="0.01">
                                <button type="button" @click="removeEditExpense(index)" class="remove-expense">&times;</button>
                            </div>
                            <button type="button" @click="addEditExpense" class="button">Add Expense</button>
                        </div>
                        <div class="form-group total-amount">
                            <strong>Total Amount: â‚±{{ calculateEditTotal }}</strong>
                        </div>
                        <div class="modal-footer">
                            <button type="button" @click="closeViewModal" class="button cancel">Cancel</button>
                            <button type="submit" class="button">Update Bill</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
